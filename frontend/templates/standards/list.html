{% extends "base.html" %}

{% block title %}Standards - EHS Electronic Journal{% endblock %}
{% block page_title %}Standards Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/tables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/forms.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-info">
            <h2>Standards Management</h2>
            <p>Manage MM and FlameAA standards with concentration tracking and verification</p>
        </div>
        <div class="page-actions">
            <a href="/standards/{{ standard_type.lower() }}/add" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Standard
            </a>
            <button id="export-btn" class="btn btn-secondary">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Standards Type Navigation -->
<div class="nav-tabs-container">
    <ul class="nav-tabs">
        <li class="nav-tab {% if standard_type == 'mm' %}active{% endif %}">
            <a href="/standards/mm">MM Standards</a>
        </li>
        <li class="nav-tab {% if standard_type == 'flameaa' %}active{% endif %}">
            <a href="/standards/flameaa">FlameAA Standards</a>
        </li>
    </ul>
</div>

<!-- Search and Filter Controls -->
<div class="filters-section">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="search-input">Search Standards</label>
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="Search by name, batch number, or element...">
                    <button class="btn btn-outline" id="clear-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="type-filter">Standard Type</label>
                <select id="type-filter" class="form-control">
                    <option value="">All Types</option>
                    <option value="QC">QC Standards</option>
                    <option value="Calibration">Calibration</option>
                    <option value="Spike">Spike Standards</option>
                    <option value="Blank">Blank Standards</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <label for="status-filter">Status</label>
                <select id="status-filter" class="form-control">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="certified">Certified</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Standards Table -->
<div class="table-container">
    <div class="table-responsive">
        <table class="data-table" id="standards-table">
            <thead>
                <tr>
                    <th>Standard Name</th>
                    <th>Batch Number</th>
                    <th>Type</th>
                    <th>Concentration</th>
                    {% if standard_type == 'mm' %}
                    <th>Elements</th>
                    {% else %}
                    <th>Element</th>
                    <th>Curve Type</th>
                    {% endif %}
                    <th>Prep Date</th>
                    <th>Expiration</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for standard in standards %}
                <tr class="table-row" data-id="{{ standard.id }}">
                    <td>
                        <div class="cell-content">
                            <strong>{{ standard.standard_name }}</strong>
                            {% if standard.certified %}
                            <span class="badge badge-success">Certified</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ standard.batch_number }}</td>
                    <td>{{ standard.standard_type }}</td>
                    <td>
                        <div class="concentration-cell">
                            <strong>{{ standard.target_concentration }} ppm</strong>
                            {% if standard.actual_concentration and standard.actual_concentration != standard.target_concentration %}
                            <br><small class="text-muted">Actual: {{ standard.actual_concentration }} ppm</small>
                            {% endif %}
                        </div>
                    </td>
                    {% if standard_type == 'mm' %}
                    <td>
                        <div class="elements-cell">
                            {% if standard.elements %}
                            <span class="elements-list">{{ standard.elements|replace(',', ', ') }}</span>
                            {% else %}
                            <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </td>
                    {% else %}
                    <td>{{ standard.element or 'N/A' }}</td>
                    <td>{{ standard.curve_type or 'Linear' }}</td>
                    {% endif %}
                    <td>{{ standard.preparation_date.strftime('%Y-%m-%d') if standard.preparation_date else 'N/A' }}</td>
                    <td>
                        {% if standard.expiration_date %}
                        <span class="expiration-date {% if standard.expiration_date < current_date %}expired{% elif (standard.expiration_date - current_date).days < 30 %}warning{% endif %}">
                            {{ standard.expiration_date.strftime('%Y-%m-%d') }}
                        </span>
                        {% else %}
                        <span class="text-muted">No expiration</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if standard.expiration_date and standard.expiration_date < current_date %}
                        <span class="status-badge status-expired">Expired</span>
                        {% elif standard.certified %}
                        <span class="status-badge status-certified">Certified</span>
                        {% else %}
                        <span class="status-badge status-active">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/standards/{{ standard_type }}/{{ standard.id }}" class="btn btn-sm btn-outline" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/standards/{{ standard_type }}/edit/{{ standard.id }}" class="btn btn-sm btn-outline" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline text-danger delete-btn" data-id="{{ standard.id }}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Empty State -->
{% if not standards %}
<div class="empty-state">
    <div class="empty-state-icon">
        <i class="fas fa-balance-scale"></i>
    </div>
    <h3>No {{ standard_type|upper }} Standards Found</h3>
    <p>Get started by adding your first {{ 'MM' if standard_type == 'mm' else 'FlameAA' }} standard.</p>
    <a href="/standards/{{ standard_type }}/add" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Standard
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const typeFilter = document.getElementById('type-filter');
    const statusFilter = document.getElementById('status-filter');
    
    // Table filtering
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const typeValue = typeFilter.value.toLowerCase();
        const statusValue = statusFilter.value.toLowerCase();
        const rows = document.querySelectorAll('#standards-table tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const type = row.cells[2].textContent.toLowerCase();
            const status = row.querySelector('.status-badge').textContent.toLowerCase();
            
            const matchesSearch = text.includes(searchTerm);
            const matchesType = !typeValue || type.includes(typeValue);
            const matchesStatus = !statusValue || status.includes(statusValue);
            
            row.style.display = (matchesSearch && matchesType && matchesStatus) ? '' : 'none';
        });
    }
    
    searchInput.addEventListener('input', filterTable);
    typeFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        filterTable();
    });
    
    // Delete functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            if (confirm('Are you sure you want to delete this standard? This action cannot be undone.')) {
                // Implement delete functionality
                fetch(`/standards/{{ standard_type }}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error deleting standard. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting standard. Please try again.');
                });
            }
        });
    });
    
    // Export functionality
    document.getElementById('export-btn').addEventListener('click', function() {
        const exportUrl = `/standards/{{ standard_type.lower() }}/export`;
        window.open(exportUrl, '_blank');
    });
});
</script>
{% endblock %}