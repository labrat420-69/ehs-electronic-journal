{% extends "base.html" %}

{% block title %}ICP-OES Maintenance - EHS Electronic Journal{% endblock %}
{% block page_title %}ICP-OES Maintenance Records{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/tables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/forms.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-info">
            <h2>ICP-OES Maintenance Records</h2>
            <p>Detailed maintenance tracking for ICP-OES instrumentation including performance verification</p>
        </div>
        <div class="page-actions">
            <a href="/maintenance/icp-oes/add" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Maintenance Record
            </a>
            <button id="export-btn" class="btn btn-secondary">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Maintenance Type Navigation -->
<div class="nav-tabs-container">
    <ul class="nav-tabs">
        <li class="nav-tab">
            <a href="/maintenance/">All Maintenance</a>
        </li>
        <li class="nav-tab active">
            <a href="/maintenance/icp-oes">ICP-OES</a>
        </li>
    </ul>
</div>

<!-- ICP-OES Status Card -->
<div class="status-container">
    <div class="status-card">
        <div class="status-header">
            <h3>ICP-OES System Status</h3>
            <span class="status-badge {% if system_status == 'Operational' %}status-current{% elif system_status == 'Under Maintenance' %}status-warning{% else %}status-overdue{% endif %}">
                {{ system_status or 'Unknown' }}
            </span>
        </div>
        <div class="status-content">
            <div class="status-grid">
                <div class="status-item">
                    <span class="label">Last Maintenance:</span>
                    <span class="value">
                        {% if last_maintenance %}
                        {{ last_maintenance.maintenance_date.strftime('%Y-%m-%d') }}
                        {% else %}
                        No records
                        {% endif %}
                    </span>
                </div>
                <div class="status-item">
                    <span class="label">Next Scheduled:</span>
                    <span class="value">{{ next_maintenance or 'Not scheduled' }}</span>
                </div>
                <div class="status-item">
                    <span class="label">Total Records:</span>
                    <span class="value">{{ maintenance_records|length }}</span>
                </div>
                <div class="status-item">
                    <span class="label">This Quarter Cost:</span>
                    <span class="value">${{ "%.2f"|format(quarterly_cost or 0) }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="filters-section">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="date-from">Date From</label>
                <input type="date" id="date-from" class="form-control">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="date-to">Date To</label>
                <input type="date" id="date-to" class="form-control">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="type-filter">Maintenance Type</label>
                <select id="type-filter" class="form-control">
                    <option value="">All Types</option>
                    <option value="Preventive">Preventive</option>
                    <option value="Corrective">Corrective</option>
                    <option value="Calibration">Calibration</option>
                    <option value="Cleaning">Cleaning</option>
                    <option value="Parts Replacement">Parts Replacement</option>
                    <option value="Software Update">Software Update</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Maintenance Records Table -->
<div class="table-container">
    <div class="table-responsive">
        <table class="data-table" id="maintenance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Performed By</th>
                    <th>Duration</th>
                    <th>Parts Used</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in maintenance_records %}
                <tr class="table-row" data-id="{{ record.id }}">
                    <td>{{ record.maintenance_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <span class="type-badge type-{{ record.maintenance_type|lower|replace(' ', '-') }}">
                            {{ record.maintenance_type }}
                        </span>
                    </td>
                    <td>
                        <div class="description-cell">
                            <strong>{{ record.description|truncate(50) }}</strong>
                            {% if record.issues_found %}
                            <br><small class="text-muted">Issues: {{ record.issues_found|truncate(30) }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ record.performed_by }}</td>
                    <td>
                        {% if record.duration_hours %}
                        {{ record.duration_hours }}h
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {% if record.parts_used %}
                        <span class="parts-badge">{{ record.parts_used|length }} items</span>
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>
                        {% if record.cost %}
                        ${{ "%.2f"|format(record.cost) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ record.status|lower|replace(' ', '-') }}">
                            {{ record.status or 'Completed' }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/maintenance/icp-oes/{{ record.id }}" class="btn btn-sm btn-outline" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/maintenance/icp-oes/edit/{{ record.id }}" class="btn btn-sm btn-outline" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline text-danger delete-btn" data-id="{{ record.id }}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Empty State -->
{% if not maintenance_records %}
<div class="empty-state">
    <div class="empty-state-icon">
        <i class="fas fa-cog"></i>
    </div>
    <h3>No ICP-OES Maintenance Records Found</h3>
    <p>Get started by adding your first ICP-OES maintenance record.</p>
    <a href="/maintenance/icp-oes/add" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Maintenance Record
    </a>
</div>
{% endif %}

<!-- Maintenance Statistics -->
{% if maintenance_records %}
<div class="stats-container">
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Average Duration</div>
                <div class="stats-icon">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div class="stats-value">{{ "%.1f"|format(avg_duration or 0) }}h</div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Preventive %</div>
                <div class="stats-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
            </div>
            <div class="stats-value">{{ "%.0f"|format(preventive_percentage or 0) }}%</div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">YTD Cost</div>
                <div class="stats-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
            <div class="stats-value">${{ "%.0f"|format(ytd_cost or 0) }}</div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Uptime</div>
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="stats-value">{{ "%.1f"|format(uptime_percentage or 0) }}%</div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Date filtering
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const typeFilter = document.getElementById('type-filter');
    
    // Set default date range (last 6 months)
    const today = new Date();
    const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate());
    
    dateTo.value = today.toISOString().split('T')[0];
    dateFrom.value = sixMonthsAgo.toISOString().split('T')[0];
    
    // Table filtering
    function filterTable() {
        const fromDate = new Date(dateFrom.value);
        const toDate = new Date(dateTo.value);
        const typeValue = typeFilter.value.toLowerCase();
        const rows = document.querySelectorAll('#maintenance-table tbody tr');
        
        rows.forEach(row => {
            const dateText = row.cells[0].textContent;
            const rowDate = new Date(dateText);
            const type = row.cells[1].textContent.toLowerCase();
            
            const matchesDate = (!dateFrom.value || rowDate >= fromDate) && 
                              (!dateTo.value || rowDate <= toDate);
            const matchesType = !typeValue || type.includes(typeValue);
            
            row.style.display = (matchesDate && matchesType) ? '' : 'none';
        });
    }
    
    dateFrom.addEventListener('change', filterTable);
    dateTo.addEventListener('change', filterTable);
    typeFilter.addEventListener('change', filterTable);
    
    // Delete functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            if (confirm('Are you sure you want to delete this maintenance record? This action cannot be undone.')) {
                fetch(`/maintenance/icp-oes/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error deleting record. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting record. Please try again.');
                });
            }
        });
    });
    
    // Export functionality
    document.getElementById('export-btn').addEventListener('click', function() {
        const fromDate = dateFrom.value;
        const toDate = dateTo.value;
        const type = typeFilter.value;
        
        let exportUrl = '/maintenance/icp-oes/export';
        const params = new URLSearchParams();
        
        if (fromDate) params.append('from', fromDate);
        if (toDate) params.append('to', toDate);
        if (type) params.append('type', type);
        
        if (params.toString()) {
            exportUrl += '?' + params.toString();
        }
        
        window.open(exportUrl, '_blank');
    });
});
</script>

<style>
/* Additional styles for ICP-OES maintenance */
.status-container {
    margin-bottom: 30px;
}

.status-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e5e7eb;
}

.type-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.type-preventive {
    background: #f0fdf4;
    color: #047857;
}

.type-corrective {
    background: #fef2f2;
    color: #dc2626;
}

.type-calibration {
    background: #eff6ff;
    color: #1d4ed8;
}

.type-cleaning {
    background: #f8fafc;
    color: #475569;
}

.type-parts-replacement {
    background: #fffbeb;
    color: #d97706;
}

.type-software-update {
    background: #faf5ff;
    color: #7c3aed;
}

.parts-badge {
    background: #f3f4f6;
    color: #6b7280;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
}

.description-cell {
    max-width: 200px;
}
</style>
{% endblock %}