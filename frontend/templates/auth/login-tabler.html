{% extends "base.html" %}

{% block title %}Login - EHS Electronic Journal{% endblock %}

{% block body_class %}d-flex flex-column{% endblock %}

{% block extra_css %}
<style>
    /* Hide main layout elements for auth page */
    .navbar, .navbar-aside, .page-wrapper, .page-body, .page-header, .page-content {
        display: none;
    }
    
    body {
        background: linear-gradient(135deg, var(--tblr-primary) 0%, var(--tblr-info) 100%);
        min-height: 100vh;
    }
    
    .auth-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1.5rem;
    }
    
    .auth-card {
        width: 100%;
        max-width: 420px;
        background: var(--tblr-card-bg);
        border-radius: var(--tblr-border-radius-lg);
        box-shadow: var(--tblr-box-shadow-lg);
        overflow: hidden;
    }
    
    .auth-card-header {
        background: linear-gradient(135deg, var(--tblr-primary-lt), var(--tblr-card-bg));
        padding: 2rem;
        text-align: center;
        border-bottom: 1px solid var(--tblr-border-color-light);
    }
    
    .auth-card-body {
        padding: 2rem;
    }
    
    .auth-card-footer {
        background: var(--tblr-body-bg);
        padding: 1.5rem 2rem;
        text-align: center;
        border-top: 1px solid var(--tblr-border-color-light);
    }
    
    .auth-logo {
        width: 4rem;
        height: 4rem;
        background: var(--tblr-primary);
        color: var(--tblr-primary-fg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }
    
    .auth-title {
        font-size: 1.5rem;
        font-weight: var(--tblr-font-weight-semibold);
        color: var(--tblr-body-color);
        margin: 0 0 0.5rem 0;
    }
    
    .auth-subtitle {
        color: var(--tblr-secondary);
        font-size: 0.875rem;
        margin: 0;
    }
    
    .form-floating {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .form-floating > .form-control {
        height: calc(3.5rem + 2px);
        line-height: 1.25;
        padding: 1rem 0.75rem 0.25rem 0.75rem;
    }
    
    .form-floating > label {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        padding: 1rem 0.75rem;
        pointer-events: none;
        border: 1px solid transparent;
        transform-origin: 0 0;
        transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out;
    }
    
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        opacity: 0.65;
        transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
    }
    
    .form-check {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .form-check-input {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        border: 1px solid var(--tblr-border-color);
        border-radius: var(--tblr-border-radius-sm);
    }
    
    .form-check-input:checked {
        background-color: var(--tblr-primary);
        border-color: var(--tblr-primary);
    }
    
    .btn-auth {
        width: 100%;
        height: 3rem;
        font-size: 1rem;
        font-weight: var(--tblr-font-weight-medium);
        margin-bottom: 1rem;
    }
    
    .auth-links {
        text-align: center;
        margin-top: 1rem;
    }
    
    .auth-links a {
        color: var(--tblr-primary);
        text-decoration: none;
        font-size: 0.875rem;
    }
    
    .auth-links a:hover {
        text-decoration: underline;
    }
    
    .company-info {
        color: var(--tblr-secondary);
        font-size: 0.75rem;
        line-height: 1.4;
    }
    
    /* Loading state */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }
    
    .btn-loading .btn-text {
        opacity: 0;
    }
    
    .btn-loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1rem;
        height: 1rem;
        margin: -0.5rem 0 0 -0.5rem;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Dark theme adjustments */
    [data-bs-theme="dark"] {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-card">
        <div class="auth-card-header">
            <div class="auth-logo">
                <i class="fas fa-flask"></i>
            </div>
            <h1 class="auth-title">Welcome Back</h1>
            <p class="auth-subtitle">Sign in to your laboratory management system</p>
        </div>
        
        <div class="auth-card-body">
            <form method="POST" action="/auth/login" id="loginForm">
                <div class="form-floating">
                    <input 
                        type="text" 
                        class="form-control" 
                        id="username" 
                        name="username" 
                        placeholder="Username"
                        required 
                        autocomplete="username"
                        autofocus
                    >
                    <label for="username">Username</label>
                </div>
                
                <div class="form-floating">
                    <input 
                        type="password" 
                        class="form-control" 
                        id="password" 
                        name="password" 
                        placeholder="Password"
                        required 
                        autocomplete="current-password"
                    >
                    <label for="password">Password</label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="remember" name="remember" value="1">
                    <label class="form-check-label" for="remember">
                        Remember me for 30 days
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary btn-auth" id="loginButton">
                    <span class="btn-text">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Sign In
                    </span>
                </button>
                
                <div class="auth-links">
                    <a href="/auth/forgot-password">Forgot your password?</a>
                </div>
            </form>
        </div>
        
        <div class="auth-card-footer">
            <div class="company-info">
                <div><strong>EHS Labs</strong></div>
                <div>Environmental Hazards Services</div>
                <div class="mt-2">&copy; 2025 Electronic Laboratory Journal</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    
    // Form submission handling
    loginForm.addEventListener('submit', function(e) {
        // Basic client-side validation
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        
        if (!username) {
            e.preventDefault();
            showValidationError(usernameInput, 'Please enter your username');
            return;
        }
        
        if (!password) {
            e.preventDefault();
            showValidationError(passwordInput, 'Please enter your password');
            return;
        }
        
        if (password.length < 6) {
            e.preventDefault();
            showValidationError(passwordInput, 'Password must be at least 6 characters');
            return;
        }
        
        // Show loading state
        setLoadingState(true);
    });
    
    // Input validation on blur
    usernameInput.addEventListener('blur', function() {
        if (this.value.trim().length === 0) {
            showValidationError(this, 'Username is required');
        } else {
            clearValidationError(this);
        }
    });
    
    passwordInput.addEventListener('blur', function() {
        if (this.value.length === 0) {
            showValidationError(this, 'Password is required');
        } else if (this.value.length < 6) {
            showValidationError(this, 'Password must be at least 6 characters');
        } else {
            clearValidationError(this);
        }
    });
    
    // Clear validation errors on input
    [usernameInput, passwordInput].forEach(input => {
        input.addEventListener('input', function() {
            clearValidationError(this);
        });
    });
    
    // Handle URL parameters for messages
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('logout') === 'true') {
        showMessage('success', 'You have been logged out successfully');
    }
    
    if (urlParams.get('session_expired') === 'true') {
        showMessage('warning', 'Your session has expired. Please log in again.');
    }
    
    if (urlParams.get('access_denied') === 'true') {
        showMessage('error', 'Access denied. Please log in to continue.');
    }
    
    if (urlParams.get('error')) {
        showMessage('error', decodeURIComponent(urlParams.get('error')));
    }
    
    // Clear URL parameters
    if (urlParams.toString()) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    
    // Helper functions
    function setLoadingState(loading) {
        if (loading) {
            loginButton.classList.add('btn-loading');
            loginButton.disabled = true;
            usernameInput.disabled = true;
            passwordInput.disabled = true;
        } else {
            loginButton.classList.remove('btn-loading');
            loginButton.disabled = false;
            usernameInput.disabled = false;
            passwordInput.disabled = false;
        }
    }
    
    function showValidationError(input, message) {
        clearValidationError(input);
        
        input.classList.add('is-invalid');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        
        input.parentNode.appendChild(errorDiv);
        input.focus();
    }
    
    function clearValidationError(input) {
        input.classList.remove('is-invalid');
        
        const errorDiv = input.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.remove();
        }
    }
    
    function showMessage(type, message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible mb-3`;
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
                <div class="flex-grow-1">${message}</div>
            </div>
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        // Insert at the top of the card body
        const cardBody = document.querySelector('.auth-card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
        
        // Auto-remove success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }
    
    // Handle form reset on page reload
    window.addEventListener('beforeunload', function() {
        setLoadingState(false);
    });
});
</script>

<style>
    /* Enhanced form validation styles */
    .form-control.is-invalid {
        border-color: var(--tblr-danger);
        box-shadow: 0 0 0 0.2rem rgba(234, 67, 53, 0.25);
    }
    
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: var(--tblr-danger);
    }
</style>
{% endblock %}