{% extends "base.html" %}

{% block title %}Dashboard - EHS Electronic Journal{% endblock %}
{% block page_title %}EHS Electronic Journal Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block page_description %}
<div class="text-muted">Real-time laboratory management system overview</div>
{% endblock %}

{% block page_actions %}
<div class="btn-list">
    <a href="/chemical_inventory/add" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>
        Add Chemical
    </a>
    <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-cog me-2"></i>
            Actions
        </button>
        <div class="dropdown-menu">
            <a class="dropdown-item" href="/analytics">
                <i class="fas fa-chart-line me-2"></i>
                View Analytics
            </a>
            <a class="dropdown-item" href="/maintenance/">
                <i class="fas fa-wrench me-2"></i>
                Maintenance Dashboard
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" onclick="window.location.reload()">
                <i class="fas fa-sync-alt me-2"></i>
                Refresh Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Dashboard Statistics Cards -->
<div class="row row-deck row-cards mb-4">
    <!-- Chemical Inventory Card -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Chemical Inventory</div>
                    <div class="ms-auto">
                        <div class="status-indicator bg-{{ 'danger' if stats.chemicals.expired > 0 else 'success' if stats.chemicals.low_stock == 0 else 'warning' }}"></div>
                    </div>
                </div>
                <div class="h1 mb-3 text-primary">{{ stats.chemicals.total_active }}</div>
                <div class="d-flex mb-2">
                    <div>Total Active</div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-{{ 'danger' if stats.chemicals.low_stock > 0 else 'success' }}">{{ stats.chemicals.low_stock }}</div>
                            <div class="lab-metric-label">Low Stock</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-{{ 'danger' if stats.chemicals.expired > 0 else 'success' }}">{{ stats.chemicals.expired }}</div>
                            <div class="lab-metric-label">Expired</div>
                        </div>
                    </div>
                </div>
                <div class="lab-metric">
                    <div class="lab-metric-value text-info">{{ stats.chemicals.recent_activity }}</div>
                    <div class="lab-metric-label">Recent Activity</div>
                </div>
                <div class="progress progress-sm mt-2">
                    <div class="progress-bar bg-{{ 'danger' if stats.chemicals.expired > 0 else 'warning' if stats.chemicals.low_stock > 0 else 'success' }}" 
                         style="width: {{ ((stats.chemicals.total_active - stats.chemicals.low_stock - stats.chemicals.expired) / stats.chemicals.total_active * 100) if stats.chemicals.total_active > 0 else 100 }}%" 
                         role="progressbar"></div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-list justify-content-end">
                    <a href="/chemical_inventory/" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye me-1"></i>
                        View Inventory
                    </a>
                    <a href="/chemical_inventory/add" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Add Chemical
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Reagents Card -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Reagents</div>
                    <div class="ms-auto">
                        <div class="status-indicator bg-success"></div>
                    </div>
                </div>
                <div class="h1 mb-3 text-success">{{ stats.reagents.mm_active + stats.reagents.pb_active + stats.reagents.tclp_active }}</div>
                <div class="d-flex mb-2">
                    <div>Total Active</div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-success">{{ stats.reagents.mm_active }}</div>
                            <div class="lab-metric-label">MM Active</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-success">{{ stats.reagents.pb_active }}</div>
                            <div class="lab-metric-label">Pb Active</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-success">{{ stats.reagents.tclp_active }}</div>
                            <div class="lab-metric-label">TCLP Active</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-list justify-content-end">
                    <a href="/reagents/mm" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-vial me-1"></i>
                        MM Reagents
                    </a>
                    <a href="/reagents/pb" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-vial me-1"></i>
                        Pb Reagents
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Standards Card -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Standards</div>
                    <div class="ms-auto">
                        <div class="status-indicator bg-warning"></div>
                    </div>
                </div>
                <div class="h1 mb-3 text-warning">{{ stats.standards.mm_standards + stats.standards.flameaa_standards }}</div>
                <div class="d-flex mb-2">
                    <div>Total Active</div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-warning">{{ stats.standards.mm_standards }}</div>
                            <div class="lab-metric-label">MM Standards</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-warning">{{ stats.standards.flameaa_standards }}</div>
                            <div class="lab-metric-label">FlameAA Standards</div>
                        </div>
                    </div>
                </div>
                <div class="lab-metric">
                    <div class="lab-metric-value text-muted">{{ stats.standards.verified if stats.standards.verified != '-' else 'N/A' }}</div>
                    <div class="lab-metric-label">Verified</div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-list justify-content-end">
                    <a href="/standards/mm" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-balance-scale me-1"></i>
                        MM Standards
                    </a>
                    <a href="/standards/flameaa" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-balance-scale me-1"></i>
                        FlameAA Standards
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Card -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Equipment</div>
                    <div class="ms-auto">
                        <div class="status-indicator bg-{{ 'danger' if stats.equipment.overdue_calibration > 0 else 'success' }}"></div>
                    </div>
                </div>
                <div class="h1 mb-3 text-danger">{{ stats.equipment.total_equipment }}</div>
                <div class="d-flex mb-2">
                    <div>Total Equipment</div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-{{ 'danger' if stats.equipment.overdue_calibration > 0 else 'success' }}">{{ stats.equipment.overdue_calibration }}</div>
                            <div class="lab-metric-label">Overdue Calibration</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-info">{{ stats.equipment.recent_pipette_tests }}</div>
                            <div class="lab-metric-label">Pipette Tests (7d)</div>
                        </div>
                    </div>
                </div>
                <div class="lab-metric">
                    <div class="lab-metric-value text-info">{{ stats.equipment.recent_water_tests }}</div>
                    <div class="lab-metric-label">Water Tests (7d)</div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-list justify-content-end">
                    <a href="/equipment/" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-list me-1"></i>
                        Equipment List
                    </a>
                    <a href="/equipment/pipettes" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-eyedropper me-1"></i>
                        Pipette Log
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Card -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Maintenance</div>
                    <div class="ms-auto">
                        <div class="status-indicator bg-info"></div>
                    </div>
                </div>
                <div class="h1 mb-3 text-info">{{ stats.maintenance.recent_activities }}</div>
                <div class="d-flex mb-2">
                    <div>Recent Activities</div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-muted">{{ stats.maintenance.scheduled if stats.maintenance.scheduled != '-' else 'N/A' }}</div>
                            <div class="lab-metric-label">Scheduled</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-muted">{{ stats.maintenance.overdue if stats.maintenance.overdue != '-' else 'N/A' }}</div>
                            <div class="lab-metric-label">Overdue</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="lab-metric">
                            <div class="lab-metric-value text-muted">{{ stats.maintenance.this_month if stats.maintenance.this_month != '-' else 'N/A' }}</div>
                            <div class="lab-metric-label">This Month</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-list justify-content-end">
                    <a href="/maintenance/" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-cog me-1"></i>
                        Dashboard
                    </a>
                    <a href="/maintenance/icp-oes" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-microscope me-1"></i>
                        ICP-OES Log
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row row-cards">
    <!-- System Alerts Section -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    System Alerts
                </h3>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAlerts()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body" id="alerts-container">
                {% if alerts and alerts|length > 0 %}
                    {% for alert in alerts %}
                    <div class="alert alert-{{ alert.type }} mb-2">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if alert.type == 'danger' %}
                                <i class="fas fa-exclamation-circle text-danger"></i>
                                {% elif alert.type == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                {% else %}
                                <i class="fas fa-info-circle text-info"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <strong>{{ alert.title }}</strong>
                                <div class="text-muted small">{{ alert.message }}</div>
                            </div>
                            <div class="text-muted small">{{ alert.timestamp }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                    <p class="mb-0">No active alerts - all systems operating normally</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Activity Section -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clock me-2 text-primary"></i>
                    Recent Activity
                </h3>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body" id="activity-container">
                {% if recent_activity and recent_activity|length > 0 %}
                    <div class="list-group list-group-flush">
                        {% for activity in recent_activity %}
                        <div class="list-group-item px-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="avatar avatar-xs bg-{{ activity.icon_color or 'primary' }}-lt">
                                        <i class="fas fa-{{ activity.icon or 'circle' }}"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold">{{ activity.title }}</div>
                                    <div class="text-muted small">{{ activity.description }}</div>
                                </div>
                                <div class="text-muted small">{{ activity.timestamp }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-2x mb-3"></i>
                    <p class="mb-0">No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section (Placeholder Module Examples) -->
<div class="row row-cards mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-rocket me-2 text-info"></i>
                    Quick Actions & Future Modules
                </h3>
                <div class="card-actions">
                    <div class="text-muted small">Coming soon in future releases</div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Task Assignment Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-info-lt">
                                    <i class="fas fa-tasks text-info"></i>
                                </div>
                                <h4 class="card-title">Task Assignment</h4>
                                <p class="text-muted">Assign and track laboratory tasks and workflows</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Incident Logging Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-danger-lt">
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                </div>
                                <h4 class="card-title">Incident Logging</h4>
                                <p class="text-muted">Report and track safety incidents and near-misses</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Shift Notes Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-success-lt">
                                    <i class="fas fa-sticky-note text-success"></i>
                                </div>
                                <h4 class="card-title">Shift Notes</h4>
                                <p class="text-muted">Communicate important information between shifts</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Document Management Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-purple-lt">
                                    <i class="fas fa-folder-open text-purple"></i>
                                </div>
                                <h4 class="card-title">Document Management</h4>
                                <p class="text-muted">Store and organize SOPs, certificates, and reports</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Notifications Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-primary-lt">
                                    <i class="fas fa-bell text-primary"></i>
                                </div>
                                <h4 class="card-title">Notifications</h4>
                                <p class="text-muted">Real-time alerts and system notifications</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Analytics Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-secondary-lt">
                                    <i class="fas fa-chart-pie text-secondary"></i>
                                </div>
                                <h4 class="card-title">Inventory Analytics</h4>
                                <p class="text-muted">Advanced analytics and forecasting tools</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quality Control Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-warning-lt">
                                    <i class="fas fa-clipboard-check text-warning"></i>
                                </div>
                                <h4 class="card-title">Quality Control</h4>
                                <p class="text-muted">QC testing protocols and result tracking</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Tracking Placeholder -->
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="card card-link" style="opacity: 0.7;">
                            <div class="card-body text-center">
                                <div class="avatar avatar-lg mb-3 bg-teal-lt">
                                    <i class="fas fa-barcode text-teal"></i>
                                </div>
                                <h4 class="card-title">Sample Tracking</h4>
                                <p class="text-muted">Track samples from receipt to analysis</p>
                                <span class="badge bg-warning">Coming Soon</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div>
                            <strong>Development Roadmap</strong>
                            <p class="mb-0">These modules are planned for future releases. The current system provides a solid foundation for core laboratory operations with chemical inventory, reagents, standards, equipment, and maintenance tracking.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript functionality
function refreshAlerts() {
    // Add refresh functionality for alerts
    const container = document.getElementById('alerts-container');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Refreshing alerts...</p>
        </div>
    `;
    
    // Simulate refresh - replace with actual API call
    setTimeout(() => {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                <p class="mb-0">No active alerts - all systems operating normally</p>
            </div>
        `;
    }, 1500);
}

function refreshActivity() {
    // Add refresh functionality for recent activity
    const container = document.getElementById('activity-container');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading recent activity...</p>
        </div>
    `;
    
    // Simulate refresh - replace with actual API call
    setTimeout(() => {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-history fa-2x mb-3"></i>
                <p class="mb-0">No recent activity</p>
            </div>
        `;
    }, 1500);
}

// Auto-refresh dashboard data every 5 minutes
setInterval(() => {
    // Add auto-refresh logic here
    console.log('Auto-refreshing dashboard data...');
}, 300000);

// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    // Add any dashboard-specific initialization here
    console.log('Dashboard initialized with Tabler theme');
    
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[title]');
    tooltips.forEach(el => {
        el.setAttribute('data-bs-toggle', 'tooltip');
    });
});
</script>
{% endblock %}