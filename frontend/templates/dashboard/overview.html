{% extends "base.html" %}

{% block title %}Dashboard - EHS Electronic Journal{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Overview -->
<div class="row row-deck row-cards">
    <!-- Chemical Inventory Stats -->
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Chemical Inventory</div>
                    <div class="ms-auto lh-1">
                        <div class="dropdown">
                            <a class="dropdown-toggle text-muted" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Last 7 days</a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item active" href="#">Last 7 days</a>
                                <a class="dropdown-item" href="#">Last 30 days</a>
                                <a class="dropdown-item" href="#">Last 3 months</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-baseline">
                    <div class="h1 mb-0 me-2" id="total-chemicals">{{ stats.chemical_inventory.total if stats else 0 }}</div>
                    <div class="me-auto">
                        <span class="text-green d-inline-flex align-items-center lh-1">
                            Total Active
                        </span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col">
                            <div class="h4 m-0 text-warning" id="low-stock-chemicals">{{ stats.chemical_inventory.low_stock if stats else 0 }}</div>
                            <div class="text-muted">Low Stock</div>
                        </div>
                        <div class="col">
                            <div class="h4 m-0 text-danger" id="expired-chemicals">{{ stats.chemical_inventory.expired if stats else 0 }}</div>
                            <div class="text-muted">Expired</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col">
                        <a href="/chemical_inventory/" class="btn btn-primary btn-sm">
                            üóÇÔ∏è View Inventory
                        </a>
                    </div>
                    <div class="col-auto">
                        <a href="/chemical_inventory/add" class="btn btn-ghost-primary btn-sm">
                            ‚ûï Add Chemical
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reagents Stats -->
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Reagents</div>
                    <div class="ms-auto">
                        <span class="status status-green">
                            <span class="status-dot"></span>
                            Active
                        </span>
                    </div>
                </div>
                <div class="d-flex align-items-baseline">
                    <div class="h1 mb-0 me-2" id="total-reagents">{{ stats.reagents.total_active if stats else 0 }}</div>
                    <div class="me-auto">
                        <span class="text-green d-inline-flex align-items-center lh-1">
                            Total Active
                        </span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-4">
                            <div class="h4 m-0" id="mm-reagents">{{ stats.reagents.mm_active if stats else 0 }}</div>
                            <div class="text-muted small">MM</div>
                        </div>
                        <div class="col-4">
                            <div class="h4 m-0" id="pb-reagents">{{ stats.reagents.pb_active if stats else 0 }}</div>
                            <div class="text-muted small">Pb</div>
                        </div>
                        <div class="col-4">
                            <div class="h4 m-0" id="tclp-reagents">{{ stats.reagents.tclp_active if stats else 0 }}</div>
                            <div class="text-muted small">TCLP</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col">
                        <a href="/reagents/mm" class="btn btn-success btn-sm">
                            üß™ MM Reagents
                        </a>
                    </div>
                    <div class="col-auto">
                        <a href="/reagents/pb" class="btn btn-ghost-success btn-sm">
                            üß™ Pb Reagents
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standards Stats -->
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Standards</div>
                    <div class="ms-auto">
                        <span class="status status-yellow">
                            <span class="status-dot"></span>
                            Standards
                        </span>
                    </div>
                </div>
                <div class="d-flex align-items-baseline">
                    <div class="h1 mb-0 me-2" id="total-standards">{{ stats.standards.total_active if stats else 0 }}</div>
                    <div class="me-auto">
                        <span class="text-yellow d-inline-flex align-items-center lh-1">
                            Total Active
                        </span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col">
                            <div class="h4 m-0" id="mm-standards">{{ stats.standards.mm_active if stats else 0 }}</div>
                            <div class="text-muted">MM Standards</div>
                        </div>
                        <div class="col">
                            <div class="h4 m-0" id="flameaa-standards">{{ stats.standards.flameaa_active if stats else 0 }}</div>
                            <div class="text-muted">FlameAA</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col">
                        <a href="/standards/mm" class="btn btn-warning btn-sm">
                            ‚öñÔ∏è MM Standards
                        </a>
                    </div>
                    <div class="col-auto">
                        <a href="/standards/flameaa" class="btn btn-ghost-warning btn-sm">
                            ‚öñÔ∏è FlameAA
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Stats -->
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Equipment</div>
                    <div class="ms-auto">
                        <span class="status status-red">
                            <span class="status-dot"></span>
                            Equipment
                        </span>
                    </div>
                </div>
                <div class="d-flex align-items-baseline">
                    <div class="h1 mb-0 me-2" id="total-equipment">{{ stats.equipment.total if stats else 0 }}</div>
                    <div class="me-auto">
                        <span class="text-red d-inline-flex align-items-center lh-1">
                            Total Equipment
                        </span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col">
                            <div class="h4 m-0 text-danger" id="overdue-calibrations">{{ stats.equipment.overdue_calibrations if stats else 0 }}</div>
                            <div class="text-muted small">Overdue</div>
                        </div>
                        <div class="col">
                            <div class="h4 m-0 text-info" id="recent-pipette-tests">{{ stats.equipment.recent_pipette_tests if stats else 0 }}</div>
                            <div class="text-muted small">Tests (7d)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col">
                        <a href="/equipment/" class="btn btn-danger btn-sm">
                            üîß Equipment List
                        </a>
                    </div>
                    <div class="col-auto">
                        <a href="/equipment/pipettes" class="btn btn-ghost-danger btn-sm">
                            üîß Pipette Log
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Stats -->
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Maintenance</div>
                    <div class="ms-auto">
                        <span class="status status-purple">
                            <span class="status-dot"></span>
                            Maintenance
                        </span>
                    </div>
                </div>
                <div class="d-flex align-items-baseline">
                    <div class="h1 mb-0 me-2" id="recent-maintenance">{{ stats.maintenance.recent_activities if stats else 0 }}</div>
                    <div class="me-auto">
                        <span class="text-purple d-inline-flex align-items-center lh-1">
                            Recent Activities
                        </span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col">
                            <div class="h4 m-0 text-muted">-</div>
                            <div class="text-muted">Scheduled</div>
                        </div>
                        <div class="col">
                            <div class="h4 m-0 text-muted">-</div>
                            <div class="text-muted">Overdue</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col">
                        <a href="/maintenance/" class="btn btn-purple btn-sm">
                            üõ†Ô∏è Dashboard
                        </a>
                    </div>
                    <div class="col-auto">
                        <a href="/maintenance/icp-oes" class="btn btn-ghost-purple btn-sm">
                            üõ†Ô∏è ICP-OES
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Widget -->
    <div class="col-12 col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
                <div class="card-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshActivity()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div class="card-body card-body-scrollable card-body-scrollable-shadow" style="height: 400px;">
                <div id="activity-feed">
                    {% if recent_activity and recent_activity.activities %}
                        {% for activity in recent_activity.activities %}
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <span class="avatar avatar-sm rounded-circle bg-primary-lt">
                                    {{ activity.icon if activity.icon else 'üîß' }}
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-truncate">
                                    <strong>{{ activity.description }}</strong>
                                </div>
                                <div class="text-muted">{{ activity.details }}</div>
                                <div class="text-muted small">{{ activity.timestamp.strftime('%m/%d/%Y %I:%M %p') if activity.timestamp else 'Unknown time' }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty">
                            <div class="empty-icon">
                                üïí
                            </div>
                            <p class="empty-title">No recent activity</p>
                            <p class="empty-subtitle text-muted">
                                Recent system activities will appear here
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- System Alerts Widget -->
    <div class="col-12 col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    System Alerts
                    {% if alerts and alerts.summary.total > 0 %}
                    <span class="badge bg-red ms-2">{{ alerts.summary.total }}</span>
                    {% endif %}
                </h3>
                <div class="card-actions">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshAlerts()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div class="card-body card-body-scrollable card-body-scrollable-shadow" style="height: 400px;">
                <div id="alerts-container">
                    {% if alerts and alerts.alerts %}
                        {% for alert in alerts.alerts[:10] %}
                        <div class="row align-items-center mb-3">
                            <div class="col-auto">
                                <span class="avatar avatar-sm rounded-circle bg-{% if alert.type == 'danger' %}red{% elif alert.type == 'warning' %}yellow{% else %}blue{% endif %}-lt">
                                    {{ alert.icon if alert.icon else '‚ö†Ô∏è' }}
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-truncate">
                                    <strong>{{ alert.title }}</strong>
                                </div>
                                <div class="text-muted">{{ alert.message }}</div>
                                <div class="text-muted small">{{ alert.details }}</div>
                            </div>
                            {% if alert.action_url %}
                            <div class="col-auto">
                                <a href="{{ alert.action_url }}" class="btn btn-ghost-primary btn-sm">
                                    ‚Üí
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty">
                            <div class="empty-icon">
                                ‚úÖ
                            </div>
                            <p class="empty-title">No active alerts</p>
                            <p class="empty-subtitle text-muted">
                                All systems operating normally
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 5 minutes
    refreshInterval = setInterval(() => {
        refreshDashboard();
    }, 300000);
    
    // Initial load
    refreshDashboard();
});

async function refreshDashboard() {
    await Promise.all([
        refreshStats(),
        refreshAlerts(), 
        refreshActivity()
    ]);
}

async function refreshStats() {
    try {
        const response = await fetch('/api/stats');
        if (response.ok) {
            const stats = await response.json();
            updateStatsDisplay(stats);
        }
    } catch (error) {
        console.error('Error refreshing stats:', error);
    }
}

async function refreshAlerts() {
    try {
        const response = await fetch('/api/alerts');
        if (response.ok) {
            const alerts = await response.json();
            updateAlertsDisplay(alerts);
        }
    } catch (error) {
        console.error('Error refreshing alerts:', error);
    }
}

async function refreshActivity() {
    try {
        const response = await fetch('/api/activity');
        if (response.ok) {
            const activity = await response.json();
            updateActivityDisplay(activity);
        }
    } catch (error) {
        console.error('Error refreshing activity:', error);
    }
}

function updateStatsDisplay(stats) {
    // Chemical Inventory
    updateElement('total-chemicals', stats.chemical_inventory.total);
    updateElement('low-stock-chemicals', stats.chemical_inventory.low_stock);
    updateElement('expired-chemicals', stats.chemical_inventory.expired);
    
    // Reagents
    updateElement('mm-reagents', stats.reagents.mm_active);
    updateElement('pb-reagents', stats.reagents.pb_active);
    updateElement('tclp-reagents', stats.reagents.tclp_active);
    updateElement('total-reagents', stats.reagents.total_active);
    
    // Standards
    updateElement('mm-standards', stats.standards.mm_active);
    updateElement('flameaa-standards', stats.standards.flameaa_active);
    updateElement('total-standards', stats.standards.total_active);
    
    // Equipment
    updateElement('total-equipment', stats.equipment.total);
    updateElement('overdue-calibrations', stats.equipment.overdue_calibrations);
    updateElement('recent-pipette-tests', stats.equipment.recent_pipette_tests);
    
    // Maintenance
    updateElement('recent-maintenance', stats.maintenance.recent_activities);
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

function updateAlertsDisplay(alerts) {
    const container = document.getElementById('alerts-container');
    
    if (alerts.alerts && alerts.alerts.length > 0) {
        const alertsHtml = alerts.alerts.slice(0, 10).map(alert => {
            const alertColor = alert.type === 'danger' ? 'red' : alert.type === 'warning' ? 'yellow' : 'blue';
            return `
                <div class="row align-items-center mb-3">
                    <div class="col-auto">
                        <span class="avatar avatar-sm rounded-circle bg-${alertColor}-lt">
                            ${alert.icon || '‚ö†Ô∏è'}
                        </span>
                    </div>
                    <div class="col">
                        <div class="text-truncate">
                            <strong>${alert.title}</strong>
                        </div>
                        <div class="text-muted">${alert.message}</div>
                        <div class="text-muted small">${alert.details}</div>
                    </div>
                    ${alert.action_url ? `
                        <div class="col-auto">
                            <a href="${alert.action_url}" class="btn btn-ghost-primary btn-sm">
                                ‚Üí
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        container.innerHTML = alertsHtml;
    } else {
        container.innerHTML = `
            <div class="empty">
                <div class="empty-icon">
                    ‚úÖ
                </div>
                <p class="empty-title">No active alerts</p>
                <p class="empty-subtitle text-muted">
                    All systems operating normally
                </p>
            </div>
        `;
    }
}

function updateActivityDisplay(activity) {
    const feed = document.getElementById('activity-feed');
    
    if (activity.activities && activity.activities.length > 0) {
        const activitiesHtml = activity.activities.map(item => `
            <div class="row align-items-center mb-3">
                <div class="col-auto">
                    <span class="avatar avatar-sm rounded-circle bg-primary-lt">
                        ${item.icon || 'üîß'}
                    </span>
                </div>
                <div class="col">
                    <div class="text-truncate">
                        <strong>${item.description}</strong>
                    </div>
                    <div class="text-muted">${item.details}</div>
                    <div class="text-muted small">${formatTimestamp(item.timestamp)}</div>
                </div>
            </div>
        `).join('');
        
        feed.innerHTML = activitiesHtml;
    } else {
        feed.innerHTML = `
            <div class="empty">
                <div class="empty-icon">
                    üïí
                </div>
                <p class="empty-title">No recent activity</p>
                <p class="empty-subtitle text-muted">
                    Recent system activities will appear here
                </p>
            </div>
        `;
    }
}

function formatTimestamp(timestamp) {
    if (!timestamp) return 'Unknown time';
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}