{% extends "base.html" %}

{% block title %}Water Conductivity - Equipment - EHS Electronic Journal{% endblock %}
{% block page_title %}Water Conductivity Monitoring{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/tables.css') }}">
<link rel="stylesheet" href="{{ url_for('static', path='/css/forms.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-info">
            <h2>Water Conductivity Monitoring</h2>
            <p>Track DI water quality and conductivity measurements for laboratory operations</p>
        </div>
        <div class="page-actions">
            <a href="/equipment/water-conductivity/add" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Reading
            </a>
            <button id="export-btn" class="btn btn-secondary">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Equipment Type Navigation -->
<div class="nav-tabs-container">
    <ul class="nav-tabs">
        <li class="nav-tab">
            <a href="/equipment/">All Equipment</a>
        </li>
        <li class="nav-tab">
            <a href="/equipment/pipettes">Pipettes</a>
        </li>
        <li class="nav-tab active">
            <a href="/equipment/water-conductivity">Water Conductivity</a>
        </li>
    </ul>
</div>

<!-- Quick Stats Cards -->
<div class="stats-container">
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Current Reading</div>
                <div class="stats-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
            </div>
            <div class="stats-value">
                {% if latest_reading %}
                {{ "%.2f"|format(latest_reading.conductivity) }} μS/cm
                {% else %}
                No data
                {% endif %}
            </div>
            <div class="stats-subtitle">
                {% if latest_reading %}
                {{ latest_reading.measurement_date.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
            </div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">7-Day Average</div>
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
            <div class="stats-value">{{ "%.2f"|format(weekly_average) }} μS/cm</div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Readings This Month</div>
                <div class="stats-icon">
                    <i class="fas fa-calendar"></i>
                </div>
            </div>
            <div class="stats-value">{{ monthly_count }}</div>
        </div>
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">Quality Status</div>
                <div class="stats-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
            </div>
            <div class="stats-value">
                {% if latest_reading and latest_reading.conductivity <= 1.0 %}
                <span class="text-success">Excellent</span>
                {% elif latest_reading and latest_reading.conductivity <= 5.0 %}
                <span class="text-warning">Good</span>
                {% elif latest_reading %}
                <span class="text-danger">Poor</span>
                {% else %}
                Unknown
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="filters-section">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="date-from">Date From</label>
                <input type="date" id="date-from" class="form-control">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="date-to">Date To</label>
                <input type="date" id="date-to" class="form-control">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="source-filter">Water Source</label>
                <select id="source-filter" class="form-control">
                    <option value="">All Sources</option>
                    <option value="DI System">DI System</option>
                    <option value="Tap Water">Tap Water</option>
                    <option value="Distilled">Distilled Water</option>
                    <option value="Other">Other</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Conductivity Chart -->
<div class="chart-container">
    <div class="chart-card">
        <div class="chart-header">
            <h3>Conductivity Trend</h3>
            <div class="chart-actions">
                <button class="btn btn-sm btn-outline" id="zoom-week">7 Days</button>
                <button class="btn btn-sm btn-outline" id="zoom-month">30 Days</button>
                <button class="btn btn-sm btn-outline active" id="zoom-quarter">90 Days</button>
            </div>
        </div>
        <div class="chart-content">
            <canvas id="conductivity-chart" width="800" height="400"></canvas>
        </div>
    </div>
</div>

<!-- Conductivity Table -->
<div class="table-container">
    <div class="table-responsive">
        <table class="data-table" id="conductivity-table">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Conductivity (μS/cm)</th>
                    <th>Temperature (°C)</th>
                    <th>Water Source</th>
                    <th>Location</th>
                    <th>Quality</th>
                    <th>Recorded By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reading in conductivity_readings %}
                <tr class="table-row" data-id="{{ reading.id }}">
                    <td>{{ reading.measurement_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <div class="conductivity-cell">
                            <strong>{{ "%.2f"|format(reading.conductivity) }}</strong>
                            <div class="conductivity-bar">
                                <div class="conductivity-fill" style="width: {{ (reading.conductivity / 10.0 * 100)|min(100) }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>{{ "%.1f"|format(reading.temperature) if reading.temperature else 'N/A' }}</td>
                    <td>{{ reading.water_source or 'DI System' }}</td>
                    <td>{{ reading.location or 'Main Lab' }}</td>
                    <td>
                        {% if reading.conductivity <= 1.0 %}
                        <span class="status-badge status-current">Excellent</span>
                        {% elif reading.conductivity <= 5.0 %}
                        <span class="status-badge status-warning">Good</span>
                        {% else %}
                        <span class="status-badge status-overdue">Poor</span>
                        {% endif %}
                    </td>
                    <td>{{ reading.recorded_by or current_user.full_name }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="/equipment/water-conductivity/{{ reading.id }}" class="btn btn-sm btn-outline" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/equipment/water-conductivity/edit/{{ reading.id }}" class="btn btn-sm btn-outline" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline text-danger delete-btn" data-id="{{ reading.id }}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Empty State -->
{% if not conductivity_readings %}
<div class="empty-state">
    <div class="empty-state-icon">
        <i class="fas fa-tint"></i>
    </div>
    <h3>No Conductivity Readings Found</h3>
    <p>Get started by recording your first water conductivity measurement.</p>
    <a href="/equipment/water-conductivity/add" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Reading
    </a>
</div>
{% endif %}

<!-- Quality Guidelines -->
<div class="info-container">
    <div class="info-card">
        <div class="info-header">
            <h3>Water Quality Guidelines</h3>
        </div>
        <div class="info-content">
            <div class="quality-guidelines">
                <div class="quality-item excellent">
                    <span class="quality-range">≤ 1.0 μS/cm</span>
                    <span class="quality-label">Excellent</span>
                    <span class="quality-description">Suitable for all analytical procedures</span>
                </div>
                <div class="quality-item good">
                    <span class="quality-range">1.1 - 5.0 μS/cm</span>
                    <span class="quality-label">Good</span>
                    <span class="quality-description">Acceptable for most applications</span>
                </div>
                <div class="quality-item poor">
                    <span class="quality-range">> 5.0 μS/cm</span>
                    <span class="quality-label">Poor</span>
                    <span class="quality-description">May require system maintenance</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart initialization (placeholder - would use Chart.js or similar)
    const chartCanvas = document.getElementById('conductivity-chart');
    if (chartCanvas) {
        // Initialize chart with conductivity data
        // This would typically use Chart.js or similar library
    }
    
    // Date filtering
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    const sourceFilter = document.getElementById('source-filter');
    
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
    
    dateTo.value = today.toISOString().split('T')[0];
    dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
    
    // Table filtering
    function filterTable() {
        const fromDate = new Date(dateFrom.value);
        const toDate = new Date(dateTo.value);
        const sourceValue = sourceFilter.value.toLowerCase();
        const rows = document.querySelectorAll('#conductivity-table tbody tr');
        
        rows.forEach(row => {
            const dateText = row.cells[0].textContent;
            const rowDate = new Date(dateText);
            const source = row.cells[3].textContent.toLowerCase();
            
            const matchesDate = (!dateFrom.value || rowDate >= fromDate) && 
                              (!dateTo.value || rowDate <= toDate);
            const matchesSource = !sourceValue || source.includes(sourceValue);
            
            row.style.display = (matchesDate && matchesSource) ? '' : 'none';
        });
    }
    
    dateFrom.addEventListener('change', filterTable);
    dateTo.addEventListener('change', filterTable);
    sourceFilter.addEventListener('change', filterTable);
    
    // Chart zoom controls
    document.querySelectorAll('[id^="zoom-"]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[id^="zoom-"]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart based on selection
            const period = this.id.split('-')[1];
            // Implement chart update logic here
        });
    });
    
    // Delete functionality
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            if (confirm('Are you sure you want to delete this conductivity reading? This action cannot be undone.')) {
                fetch(`/equipment/water-conductivity/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error deleting reading. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting reading. Please try again.');
                });
            }
        });
    });
    
    // Export functionality
    document.getElementById('export-btn').addEventListener('click', function() {
        const fromDate = dateFrom.value;
        const toDate = dateTo.value;
        const source = sourceFilter.value;
        
        let exportUrl = '/equipment/water-conductivity/export';
        const params = new URLSearchParams();
        
        if (fromDate) params.append('from', fromDate);
        if (toDate) params.append('to', toDate);
        if (source) params.append('source', source);
        
        if (params.toString()) {
            exportUrl += '?' + params.toString();
        }
        
        window.open(exportUrl, '_blank');
    });
});
</script>

<style>
/* Additional styles for conductivity monitoring */
.conductivity-bar {
    width: 100px;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    margin-top: 4px;
}

.conductivity-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.quality-guidelines {
    display: grid;
    gap: 15px;
}

.quality-item {
    display: grid;
    grid-template-columns: 120px 100px 1fr;
    align-items: center;
    gap: 15px;
    padding: 10px;
    border-radius: 6px;
}

.quality-item.excellent { background: #f0fdf4; border-left: 4px solid #10b981; }
.quality-item.good { background: #fffbeb; border-left: 4px solid #f59e0b; }
.quality-item.poor { background: #fef2f2; border-left: 4px solid #ef4444; }

.quality-range {
    font-weight: 600;
    font-family: monospace;
}

.quality-label {
    font-weight: 500;
}

.quality-description {
    color: #6b7280;
    font-size: 14px;
}

.chart-container {
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-actions button.active {
    background: var(--primary-color);
    color: white;
}
</style>
{% endblock %}