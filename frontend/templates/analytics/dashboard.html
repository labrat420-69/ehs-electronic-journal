{% extends "base.html" %}

{% block title %}Analytics Dashboard - EHS Electronic Journal{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.plot.ly/plotly-2.26.0.min.css">
<style>
/* Enhanced Analytics Dashboard Styles */
.analytics-container {
    max-width: var(--max-width-full);
    margin: 0 auto;
    padding: 0;
}

.dashboard-controls {
    background: var(--bg-surface);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-6);
    margin-bottom: var(--spacing-6);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.controls-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-4);
}

.controls-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.controls-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-4);
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
}

.control-group label {
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.control-group select,
.control-group input {
    padding: var(--spacing-3);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    background: var(--bg-primary);
    transition: all var(--transition-fast);
    font-family: var(--font-family-sans);
}

.control-group select:focus,
.control-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-lighter);
}

.chart-actions {
    display: flex;
    gap: var(--spacing-3);
    flex-wrap: wrap;
}

.btn-chart {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-4);
    background: var(--primary-gradient);
    color: var(--text-inverse);
    border: none;
    border-radius: var(--border-radius-md);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    font-size: var(--font-size-sm);
}

.btn-chart:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-chart.secondary {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-chart.secondary:hover {
    background: var(--border-medium);
    color: var(--text-primary);
}

/* Chart Grid Layout */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
}

.chart-card {
    background: var(--bg-surface);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
    transition: all var(--transition-fast);
}

.chart-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.chart-header {
    padding: var(--spacing-4) var(--spacing-6);
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chart-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.chart-options {
    display: flex;
    gap: var(--spacing-2);
}

.chart-option-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-option-btn:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
}

.chart-body {
    padding: var(--spacing-4);
    min-height: 400px;
}

/* No Data State */
.no-data-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: var(--text-tertiary);
    text-align: center;
}

.no-data-state .icon {
    font-size: var(--font-size-4xl);
    margin-bottom: var(--spacing-4);
    opacity: 0.5;
}

.no-data-state h3 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    margin-bottom: var(--spacing-2);
}

.no-data-state p {
    font-size: var(--font-size-base);
    color: var(--text-tertiary);
    margin-bottom: var(--spacing-4);
}

/* Chart Management Panel */
.chart-management {
    background: var(--bg-surface);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: var(--spacing-6);
}

.presets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--spacing-4);
}

.preset-card {
    padding: var(--spacing-4);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.preset-card:hover {
    background: var(--primary-lighter);
    border-color: var(--primary-color);
}

.preset-card.active {
    background: var(--primary-lighter);
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}
</style>
    background: white;
}

.control-group select:focus,
.control-group input:focus {
    outline: none;
    border-color: #1a73e8;
    box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
}

.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, #1a73e8, #4285f4);
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #1557b0, #3367d6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(26,115,232,0.3);
}

.btn-secondary {
    background: #f8f9fa;
    color: #5f6368;
    border: 2px solid #dadce0;
}

.btn-secondary:hover {
    background: #e8eaed;
    border-color: #1a73e8;
    color: #1a73e8;
}

.btn-success {
    background: linear-gradient(135deg, #34a853, #66bb6a);
    color: white;
}

.btn-success:hover {
    background: linear-gradient(135deg, #2d5a2d, #5a9f5a);
    transform: translateY(-1px);
}

.btn-warning {
    background: linear-gradient(135deg, #fbbc04, #ffc107);
    color: #333;
}

.btn-danger {
    background: linear-gradient(135deg, #ea4335, #f44336);
    color: white;
}

/* Graph Container */
.graphs-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.graph-card {
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid #e8eaed;
    overflow: hidden;
    min-height: 500px;
    position: relative;
}

.graph-header {
    padding: 20px 25px;
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-bottom: 1px solid #e8eaed;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.graph-title {
    font-size: 18px;
    font-weight: 600;
    color: #202124;
    margin: 0;
}

.graph-actions {
    display: flex;
    gap: 8px;
}

.graph-btn {
    padding: 6px 12px;
    border: 1px solid #dadce0;
    background: white;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.graph-btn:hover {
    background: #f8f9fa;
    border-color: #1a73e8;
    color: #1a73e8;
}

.graph-content {
    padding: 0;
    min-height: 400px;
    background: #1a1a1a; /* Dark background for crypto-style graphs */
    position: relative;
}

.graph-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: #9aa0a6;
    text-align: center;
}

.graph-placeholder i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #dadce0;
}

/* Side Panel */
.side-panel {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid #e8eaed;
    margin-bottom: 25px;
}

.side-panel-title {
    font-size: 18px;
    font-weight: 600;
    color: #202124;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e8eaed;
}

/* Loading States */
.loading {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #e8eaed;
    border-top: 2px solid #1a73e8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .analytics-container {
        padding: 10px;
    }
    
    .graphs-container {
        grid-template-columns: 1fr;
    }
    
    .controls-row {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        justify-content: stretch;
    }
    
    .action-buttons .btn {
        flex: 1;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Controls -->
    <div class="dashboard-controls">
        <div class="controls-header">
            <h2 class="controls-title">
                <i class="fas fa-chart-line"></i>
                Chart Builder
            </h2>
            <div class="chart-actions">
                <button class="btn-chart" onclick="generateDefaultCharts()" id="default-charts-btn">
                    <i class="fas fa-magic"></i> Default Charts
                </button>
                <button class="btn-chart secondary" onclick="togglePresetPanel()" id="presets-btn">
                    <i class="fas fa-bookmark"></i> Saved Charts
                </button>
            </div>
        </div>
        
        <div class="controls-row">
            <div class="control-group">
                <label for="data-source">Data Source</label>
                <select id="data-source" onchange="updateAxisFields()">
                    <option value="">Select Data Source...</option>
                    {% for key, fields in data_sources.items() %}
                    <option value="{{ key }}">{{ key.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="control-group">
                <label for="x-axis">X-Axis Field</label>
                <select id="x-axis" disabled onchange="validateChart()">
                    <option value="">Select X-Axis...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="y-axis">Y-Axis Field</label>
                <select id="y-axis" disabled onchange="validateChart()">
                    <option value="">Select Y-Axis...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="chart-type">Chart Type</label>
                <select id="chart-type" onchange="validateChart()">
                    <option value="line">Line Chart</option>
                    <option value="bar">Bar Chart</option>
                    <option value="scatter">Scatter Plot</option>
                    <option value="pie">Pie Chart</option>
                    <option value="area">Area Chart</option>
                    <option value="histogram">Histogram</option>
                </select>
            </div>
        </div>
        
        <div class="chart-actions">
            <button class="btn-chart" onclick="generateChart()" disabled id="generate-btn">
                <i class="fas fa-chart-line"></i> Generate Chart
            </button>
            <button class="btn-chart secondary" onclick="saveChart()" disabled id="save-btn">
                <i class="fas fa-save"></i> Save Chart
            </button>
            <button class="btn-chart secondary" onclick="exportChart()" disabled id="export-btn">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Chart Management Panel (Hidden by default) -->
    <div class="chart-management" id="preset-panel" style="display: none;">
        <h3>Saved Chart Configurations</h3>
        <div class="presets-grid" id="presets-grid">
            <!-- User presets will be loaded here -->
        </div>
    </div>

    <!-- Default Charts Section -->
    <div class="charts-grid" id="default-charts">
        <!-- Default Line Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Activity Timeline
                </h3>
                <div class="chart-options">
                    <button class="chart-option-btn" onclick="refreshChart('activity-timeline')" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="chart-option-btn" onclick="fullscreenChart('activity-timeline')" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="activity-timeline-chart"></div>
            </div>
        </div>

        <!-- Default Pie Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Inventory Distribution
                </h3>
                <div class="chart-options">
                    <button class="chart-option-btn" onclick="refreshChart('inventory-distribution')" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="chart-option-btn" onclick="fullscreenChart('inventory-distribution')" title="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-body">
                <div id="inventory-distribution-chart"></div>
            </div>
        </div>
    </div>

    <!-- Custom Charts Grid -->
    <div class="charts-grid" id="custom-charts">
        <!-- Custom charts will be added here dynamically -->
    </div>

    <!-- No Data State (Hidden by default) -->
    <div class="chart-card" id="no-data-placeholder" style="display: none;">
        <div class="chart-body">
            <div class="no-data-state">
                <div class="icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>No Data Available</h3>
                <p>There isn't enough data to generate meaningful charts.<br>
                   Add some data to your system first, then return to view analytics.</p>
                <button class="btn-chart" onclick="window.location.href='/chemical_inventory/add'">
                    <i class="fas fa-plus"></i> Add Data
                </button>
            </div>
        </div>
    </div>
</div>
            </button>
            <button class="btn btn-success" onclick="exportToExcel()" disabled id="export-btn">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button class="btn btn-warning" onclick="clearGraphs()">
                <i class="fas fa-trash"></i> Clear All Graphs
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 25px;">
        <!-- Left Column: Graphs -->
        <div>
            <!-- Graphs Container -->
            <div class="graphs-container" id="graphs-container">
                <div class="graph-card" id="graph-1">
                    <div class="graph-header">
                        <h3 class="graph-title">Graph 1</h3>
                        <div class="graph-actions">
                            <button class="graph-btn" onclick="removeGraph(1)" title="Remove Graph">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="graph-content">
                        <div class="graph-placeholder">
                            <i class="fas fa-chart-line"></i>
                            <p>Select data source and fields to generate a graph</p>
                        </div>
                    </div>
                </div>
                
                <div class="graph-card" id="graph-2">
                    <div class="graph-header">
                        <h3 class="graph-title">Graph 2</h3>
                        <div class="graph-actions">
                            <button class="graph-btn" onclick="removeGraph(2)" title="Remove Graph">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="graph-content">
                        <div class="graph-placeholder">
                            <i class="fas fa-chart-bar"></i>
                            <p>Additional graph slot available</p>
                        </div>
                    </div>
                </div>
                
                <div class="graph-card" id="graph-3">
                    <div class="graph-header">
                        <h3 class="graph-title">Graph 3</h3>
                        <div class="graph-actions">
                            <button class="graph-btn" onclick="removeGraph(3)" title="Remove Graph">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="graph-content">
                        <div class="graph-placeholder">
                            <i class="fas fa-chart-area"></i>
                            <p>Third graph slot available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Side Panel -->
        <div>
            <!-- Quick Actions -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% for key, source in data_sources.items() %}
                    <button class="btn btn-secondary btn-sm" onclick="downloadTemplate('{{ key }}')">
                        <i class="fas fa-download"></i> {{ source.name }} Template
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Upcoming Reminders -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-bell"></i> Upcoming Reminders
                    <button class="btn btn-primary btn-sm" onclick="showAddReminderModal()" style="float: right; padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </h3>
                <div id="reminders-container">
                    {% if recent_reminders %}
                        {% for reminder in recent_reminders %}
                        <div class="reminder-item priority-{{ reminder.priority }}">
                            <div class="reminder-title">{{ reminder.title }}</div>
                            <div class="reminder-meta">
                                Due: {{ reminder.due_date[:10] }} | {{ reminder.reminder_type }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #9aa0a6; text-align: center; padding: 20px;">No upcoming reminders</p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Notes -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-sticky-note"></i> Department Notes
                    <button class="btn btn-primary btn-sm" onclick="showAddNoteModal()" style="float: right; padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-plus"></i>
                    </button>
                </h3>
                <div id="notes-container">
                    {% if recent_notes %}
                        {% for note in recent_notes %}
                        <div class="note-item {% if note.is_pinned %}pinned{% endif %}">
                            <div class="note-title">
                                {% if note.is_pinned %}<i class="fas fa-thumbtack"></i> {% endif %}
                                {{ note.title }}
                            </div>
                            <div class="note-content">{{ note.content[:100] }}{% if note.content|length > 100 %}...{% endif %}</div>
                            <div class="note-meta">
                                <span>{{ note.created_at[:10] }}</span>
                                <span>{{ note.note_type }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #9aa0a6; text-align: center; padding: 20px;">No recent notes</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.dataSourcesData = {{ data_sources | tojson }};
window.userPresets = {{ user_presets | tojson }};
window.publicPresets = {{ public_presets | tojson }};
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
// Analytics Dashboard JavaScript - Enhanced with Modern Features
const AnalyticsDashboard = {
    currentCharts: {},
    dataCache: {},
    
    // Data sources configuration
    dataSources: {{ data_sources | tojson }},
    
    // Initialize dashboard
    init() {
        this.bindEvents();
        this.generateDefaultCharts();
        this.loadUserPreferences();
    },
    
    // Bind event listeners
    bindEvents() {
        // Control events
        document.getElementById('data-source').addEventListener('change', this.updateAxisFields.bind(this));
        document.getElementById('x-axis').addEventListener('change', this.validateChart.bind(this));
        document.getElementById('y-axis').addEventListener('change', this.validateChart.bind(this));
        document.getElementById('chart-type').addEventListener('change', this.validateChart.bind(this));
    },
    
    // Update axis field options based on selected data source
    updateAxisFields() {
        const dataSource = document.getElementById('data-source').value;
        const xAxisSelect = document.getElementById('x-axis');
        const yAxisSelect = document.getElementById('y-axis');
        
        // Clear existing options
        xAxisSelect.innerHTML = '<option value="">Select X-Axis...</option>';
        yAxisSelect.innerHTML = '<option value="">Select Y-Axis...</option>';
        
        if (dataSource && this.dataSources[dataSource]) {
            const fields = this.dataSources[dataSource];
            
            fields.forEach(field => {
                const option = new Option(field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()), field);
                xAxisSelect.add(option.cloneNode(true));
                yAxisSelect.add(option);
            });
            
            xAxisSelect.disabled = false;
            yAxisSelect.disabled = false;
        } else {
            xAxisSelect.disabled = true;
            yAxisSelect.disabled = true;
        }
        
        this.validateChart();
    },
    
    // Validate chart configuration and enable/disable buttons
    validateChart() {
        const dataSource = document.getElementById('data-source').value;
        const xAxis = document.getElementById('x-axis').value;
        const yAxis = document.getElementById('y-axis').value;
        const chartType = document.getElementById('chart-type').value;
        
        const isValid = dataSource && ((chartType === 'pie' && xAxis) || (chartType !== 'pie' && xAxis && yAxis));
        
        document.getElementById('generate-btn').disabled = !isValid;
        document.getElementById('save-btn').disabled = !isValid;
        document.getElementById('export-btn').disabled = !isValid;
    },
    
    // Generate default charts if data is available
    async generateDefaultCharts() {
        try {
            // Check if we have sufficient data
            const hasData = await this.checkDataAvailability();
            
            if (!hasData) {
                this.showNoDataState();
                return;
            }
            
            // Generate activity timeline (line chart)
            await this.generateActivityTimeline();
            
            // Generate inventory distribution (pie chart)
            await this.generateInventoryDistribution();
            
        } catch (error) {
            console.error('Error generating default charts:', error);
            this.showNoDataState();
        }
    },
    
    // Check if sufficient data is available for charts
    async checkDataAvailability() {
        try {
            const response = await fetch('/api/analytics/data-availability');
            const data = await response.json();
            return data.sufficient_data;
        } catch (error) {
            console.error('Error checking data availability:', error);
            return false;
        }
    },
    
    // Generate activity timeline chart
    async generateActivityTimeline() {
        try {
            const response = await fetch('/api/analytics/activity-timeline');
            const data = await response.json();
            
            const trace = {
                x: data.dates,
                y: data.activities,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Activities',
                line: {
                    color: 'rgb(37, 99, 235)',
                    width: 3
                },
                marker: {
                    color: 'rgb(37, 99, 235)',
                    size: 8
                }
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Number of Activities' },
                font: { family: 'Inter, sans-serif' },
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent',
                margin: { t: 20, r: 20, b: 60, l: 60 }
            };
            
            const config = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                responsive: true
            };
            
            Plotly.newPlot('activity-timeline-chart', [trace], layout, config);
            this.currentCharts['activity-timeline'] = true;
            
        } catch (error) {
            console.error('Error generating activity timeline:', error);
            this.showChartError('activity-timeline-chart', 'Error loading activity data');
        }
    },
    
    // Generate inventory distribution chart  
    async generateInventoryDistribution() {
        try {
            const response = await fetch('/api/analytics/inventory-distribution');
            const data = await response.json();
            
            const trace = {
                values: data.values,
                labels: data.labels,
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside',
                marker: {
                    colors: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                }
            };
            
            const layout = {
                title: '',
                font: { family: 'Inter, sans-serif' },
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent',
                margin: { t: 20, r: 20, b: 20, l: 20 },
                showlegend: true,
                legend: {
                    orientation: 'v',
                    x: 1,
                    y: 0.5
                }
            };
            
            const config = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                responsive: true
            };
            
            Plotly.newPlot('inventory-distribution-chart', [trace], layout, config);
            this.currentCharts['inventory-distribution'] = true;
            
        } catch (error) {
            console.error('Error generating inventory distribution:', error);
            this.showChartError('inventory-distribution-chart', 'Error loading inventory data');
        }
    },
    
    // Show no data state
    showNoDataState() {
        document.getElementById('default-charts').style.display = 'none';
        document.getElementById('no-data-placeholder').style.display = 'block';
    },
    
    // Show chart error
    showChartError(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `
            <div class="no-data-state">
                <div class="icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Chart Error</h3>
                <p>${message}</p>
            </div>
        `;
    },
    
    // Load user preferences
    loadUserPreferences() {
        const savedPrefs = localStorage.getItem('ehs-analytics-prefs');
        if (savedPrefs) {
            try {
                const prefs = JSON.parse(savedPrefs);
                // Apply user preferences
                console.log('Loaded user preferences:', prefs);
            } catch (error) {
                console.error('Error loading user preferences:', error);
            }
        }
    },
    
    // Save user preferences
    saveUserPreferences() {
        const prefs = {
            charts: Object.keys(this.currentCharts),
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('ehs-analytics-prefs', JSON.stringify(prefs));
    }
};

// Global functions for template compatibility
function generateDefaultCharts() {
    AnalyticsDashboard.generateDefaultCharts();
}

function updateAxisFields() {
    AnalyticsDashboard.updateAxisFields();
}

function validateChart() {
    AnalyticsDashboard.validateChart();
}

function generateChart() {
    // Custom chart generation logic here
    console.log('Generating custom chart...');
}

function saveChart() {
    AnalyticsDashboard.saveUserPreferences();
    console.log('Chart configuration saved');
}

function exportChart() {
    console.log('Exporting chart...');
}

function togglePresetPanel() {
    const panel = document.getElementById('preset-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function refreshChart(chartId) {
    if (chartId === 'activity-timeline') {
        AnalyticsDashboard.generateActivityTimeline();
    } else if (chartId === 'inventory-distribution') {
        AnalyticsDashboard.generateInventoryDistribution();
    }
}

function fullscreenChart(chartId) {
    const element = document.getElementById(chartId + '-chart');
    if (element.requestFullscreen) {
        element.requestFullscreen();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    AnalyticsDashboard.init();
});
</script>
            yAxisSelect.disabled = false;
        } else {
            xAxisSelect.disabled = true;
            yAxisSelect.disabled = true;
        }
        
        checkGenerateButton();
    });
    
    // Add change listeners to other selects
    xAxisSelect.addEventListener('change', checkGenerateButton);
    yAxisSelect.addEventListener('change', checkGenerateButton);
    document.getElementById('graph-type').addEventListener('change', checkGenerateButton);
}

function checkGenerateButton() {
    const dataSource = document.getElementById('data-source').value;
    const xAxis = document.getElementById('x-axis').value;
    const yAxis = document.getElementById('y-axis').value;
    
    const generateBtn = document.getElementById('generate-btn');
    const saveBtn = document.getElementById('save-preset-btn');
    const exportBtn = document.getElementById('export-btn');
    
    const isValid = dataSource && xAxis && yAxis;
    
    generateBtn.disabled = !isValid;
    saveBtn.disabled = !isValid;
    exportBtn.disabled = !isValid;
}

async function generateGraph() {
    const dataSource = document.getElementById('data-source').value;
    const xAxis = document.getElementById('x-axis').value;
    const yAxis = document.getElementById('y-axis').value;
    const graphType = document.getElementById('graph-type').value;
    
    // Find next available graph slot
    let targetSlot = null;
    for (let i = 1; i <= 3; i++) {
        if (!activeGraphs[i]) {
            targetSlot = i;
            break;
        }
    }
    
    if (!targetSlot) {
        alert('Maximum of 3 graphs allowed. Please remove a graph first.');
        return;
    }
    
    const graphCard = document.getElementById(`graph-${targetSlot}`);
    const graphContent = graphCard.querySelector('.graph-content');
    const graphTitle = graphCard.querySelector('.graph-title');
    
    // Update title
    graphTitle.textContent = `${window.dataSourcesData[dataSource].name}: ${yAxis} vs ${xAxis}`;
    
    // Show loading
    graphContent.innerHTML = `
        <div class="graph-placeholder">
            <div class="loading">
                <div class="spinner"></div>
                <span>Generating graph...</span>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/analytics/graph-data?data_source=${dataSource}&x_field=${xAxis}&y_field=${yAxis}&graph_type=${graphType}&limit=100`);
        const result = await response.json();
        
        if (result.success) {
            // Insert the graph HTML
            graphContent.innerHTML = result.graph_html;
            
            // Mark this slot as active
            activeGraphs[targetSlot] = {
                dataSource,
                xAxis,
                yAxis,
                graphType
            };
            
        } else {
            throw new Error(result.error || 'Failed to generate graph');
        }
        
    } catch (error) {
        console.error('Error generating graph:', error);
        graphContent.innerHTML = `
            <div class="graph-placeholder">
                <i class="fas fa-exclamation-triangle" style="color: #ea4335;"></i>
                <p>Error generating graph: ${error.message}</p>
            </div>
        `;
    }
}

function removeGraph(slot) {
    const graphCard = document.getElementById(`graph-${slot}`);
    const graphContent = graphCard.querySelector('.graph-content');
    const graphTitle = graphCard.querySelector('.graph-title');
    
    // Reset to placeholder
    graphTitle.textContent = `Graph ${slot}`;
    graphContent.innerHTML = `
        <div class="graph-placeholder">
            <i class="fas fa-chart-line"></i>
            <p>Graph slot available</p>
        </div>
    `;
    
    // Remove from active graphs
    delete activeGraphs[slot];
}

function clearGraphs() {
    for (let i = 1; i <= 3; i++) {
        removeGraph(i);
    }
}

async function saveAsPreset() {
    const name = prompt('Enter preset name:');
    if (!name) return;
    
    const dataSource = document.getElementById('data-source').value;
    const xAxis = document.getElementById('x-axis').value;
    const yAxis = document.getElementById('y-axis').value;
    const graphType = document.getElementById('graph-type').value;
    
    const presetData = {
        name: name,
        description: `${graphType} chart showing ${yAxis} vs ${xAxis}`,
        graph_type: graphType,
        x_axis_field: xAxis,
        y_axis_field: yAxis,
        data_source: dataSource,
        is_public: false
    };
    
    try {
        const response = await fetch('/api/analytics/presets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(presetData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Preset saved successfully!');
            location.reload(); // Refresh to show new preset
        } else {
            throw new Error('Failed to save preset');
        }
    } catch (error) {
        console.error('Error saving preset:', error);
        alert('Error saving preset: ' + error.message);
    }
}

async function exportToExcel() {
    const dataSource = document.getElementById('data-source').value;
    const xAxis = document.getElementById('x-axis').value;
    const yAxis = document.getElementById('y-axis').value;
    
    const filename = `${dataSource}_${xAxis}_vs_${yAxis}`;
    
    try {
        const url = `/api/analytics/export-excel?data_source=${dataSource}&x_field=${xAxis}&y_field=${yAxis}&filename=${filename}`;
        window.open(url, '_blank');
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Error exporting to Excel: ' + error.message);
    }
}

async function downloadTemplate(dataSource) {
    try {
        const url = `/api/analytics/template/${dataSource}`;
        window.open(url, '_blank');
    } catch (error) {
        console.error('Error downloading template:', error);
        alert('Error downloading template: ' + error.message);
    }
}

// Placeholder functions for modal dialogs (to be implemented)
function showAddReminderModal() {
    alert('Add reminder functionality - to be implemented');
}

function showAddNoteModal() {
    alert('Add note functionality - to be implemented');
}
</script>
{% endblock %}