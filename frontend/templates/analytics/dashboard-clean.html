{% extends "base.html" %}

{% block title %}Data Analysis - EHS Electronic Journal{% endblock %}
{% block page_title %}ðŸ“Š Data Analysis Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.plot.ly/plotly-2.26.0.min.css">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Dashboard Controls -->
    <div class="dashboard-controls">
        <div class="controls-row">
            <div class="control-group">
                <label for="data-source">Data Source</label>
                <select id="data-source">
                    <option value="">Select Data Source...</option>
                    {% for key, source in data_sources.items() %}
                    <option value="{{ key }}">{{ source.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="control-group">
                <label for="model-selection">Model Selection</label>
                <select id="model-selection">
                    <option value="">Select Model...</option>
                    <option value="linear">Linear Regression</option>
                    <option value="exponential">Exponential</option>
                    <option value="polynomial">Polynomial</option>
                    <option value="logarithmic">Logarithmic</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="x-axis">X-Axis Field</label>
                <select id="x-axis" disabled>
                    <option value="">Select X-Axis...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="y-axis">Y-Axis Field</label>
                <select id="y-axis" disabled>
                    <option value="">Select Y-Axis...</option>
                </select>
            </div>

            <div class="control-group">
                <label for="z-axis">Z-Axis Field (3D)</label>
                <select id="z-axis" disabled>
                    <option value="">Select Z-Axis...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="graph-type">Graph Type</label>
                <select id="graph-type">
                    <option value="line">Line Chart</option>
                    <option value="bar">Bar Chart</option>
                    <option value="area">Area Chart</option>
                    <option value="scatter">Scatter Plot</option>
                    <option value="3d-scatter">3D Scatter</option>
                    <option value="surface">3D Surface</option>
                </select>
            </div>
        </div>
        
        <!-- Date Range Controls -->
        <div class="date-range-controls">
            <div class="date-range-type">
                <label>Date Filter Type</label>
                <select id="date-filter-type">
                    <option value="equals">=</option>
                    <option value="between">Between</option>
                    <option value="greater-equal">&gt;=</option>
                    <option value="less-equal">&lt;=</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="date-range-type">
                <label>Start Date</label>
                <input type="date" id="start-date" class="date-input">
            </div>
            <div class="date-range-type">
                <label>End Date</label>
                <input type="date" id="end-date" class="date-input">
            </div>
            <div class="date-range-type">
                <label>Quick Select</label>
                <select id="quick-date-select">
                    <option value="">Select Range...</option>
                    <option value="today">Today</option>
                    <option value="week">Past Week</option>
                    <option value="month">Past Month</option>
                    <option value="quarter">Past Quarter</option>
                    <option value="year">Past Year</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="generateGraph()" disabled id="generate-btn">
                <i class="fas fa-chart-line"></i> Generate Graph
            </button>
            <button class="btn" onclick="saveAsPreset()" disabled id="save-preset-btn">
                <i class="fas fa-save"></i> Save as Preset
            </button>
            <button class="btn" onclick="exportToExcel()" disabled id="export-btn">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button class="btn" onclick="clearGraphs()">
                <i class="fas fa-trash"></i> Clear All Graphs
            </button>
            <button class="btn" onclick="addGraph()">
                <i class="fas fa-plus"></i> Add Graph
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="graphs-container">
        <!-- Left Column: Graphs with Output Image Background -->
        <div>
            <!-- Graphs Container -->
            <div id="graphs-container">
                <div class="graph-section analysis-output" id="graph-1">
                    <div class="graph-header">
                        <h3 class="graph-title">Primary Analysis - Figure Display</h3>
                        <div class="graph-controls">
                            <button class="graph-btn" onclick="fullViewGraph(1)" title="Full View">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="graph-btn" onclick="removeGraph(1)" title="Remove Graph">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="graph-content">
                        <div class="graph-placeholder">
                            <i class="fas fa-chart-line"></i>
                            <p class="image-bg-text">Select data source and fields to generate a graph</p>
                        </div>
                    </div>
                </div>
                
                <div class="graph-section analysis-output" id="graph-2">
                    <div class="graph-header">
                        <h3 class="graph-title">Secondary Analysis - Figure Display</h3>
                        <div class="graph-controls">
                            <button class="graph-btn" onclick="fullViewGraph(2)" title="Full View">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="graph-btn" onclick="removeGraph(2)" title="Remove Graph">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="graph-content">
                        <div class="graph-placeholder">
                            <i class="fas fa-chart-bar"></i>
                            <p class="image-bg-text">Additional analysis slot available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Statistical Parameters and Controls -->
        <div>
            <!-- Statistical Parameters Table -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-calculator"></i> Statistical Parameters
                    <button class="graph-btn" onclick="addStatParameter()" style="float: right;">
                        <i class="fas fa-plus"></i>
                    </button>
                </h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="stats-parameters">
                        <tr>
                            <td>Mean</td>
                            <td>--</td>
                            <td><button class="graph-btn" onclick="removeStatParameter(this)"><i class="fas fa-minus"></i></button></td>
                        </tr>
                        <tr>
                            <td>Std Dev</td>
                            <td>--</td>
                            <td><button class="graph-btn" onclick="removeStatParameter(this)"><i class="fas fa-minus"></i></button></td>
                        </tr>
                        <tr>
                            <td>RÂ²</td>
                            <td>--</td>
                            <td><button class="graph-btn" onclick="removeStatParameter(this)"><i class="fas fa-minus"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Quick Actions -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    {% for key, source in data_sources.items() %}
                    <button class="quick-action-btn" onclick="downloadTemplate('{{ key }}')">
                        <i class="fas fa-download"></i> {{ source.name }} Template
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Upcoming Reminders -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-bell"></i> Upcoming Reminders
                    <button class="graph-btn" onclick="showAddReminderModal()" style="float: right;">
                        <i class="fas fa-plus"></i>
                    </button>
                </h3>
                <div id="reminders-container">
                    {% if recent_reminders %}
                        {% for reminder in recent_reminders %}
                        <div class="reminder-item priority-{{ reminder.priority }}" style="padding: 8px; margin-bottom: 8px; background: rgba(0, 212, 255, 0.1); border-radius: 4px;">
                            <div style="color: var(--text-inverse); font-weight: bold; font-size: 12px;">{{ reminder.title }}</div>
                            <div style="color: var(--lab-primary); font-size: 11px; font-family: var(--font-tech);">
                                Due: {{ reminder.due_date[:10] }} | {{ reminder.reminder_type }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: var(--text-inverse); text-align: center; padding: 20px; font-weight: bold;">No upcoming reminders</p>
                    {% endif %}
                </div>
            </div>

            <!-- Department Notes -->
            <div class="side-panel">
                <h3 class="side-panel-title">
                    <i class="fas fa-sticky-note"></i> Department Notes
                    <button class="graph-btn" onclick="showAddNoteModal()" style="float: right;">
                        <i class="fas fa-plus"></i>
                    </button>
                </h3>
                <div id="notes-container">
                    {% if recent_notes %}
                        {% for note in recent_notes %}
                        <div class="note-item" style="padding: 8px; margin-bottom: 8px; background: rgba(0, 212, 255, 0.1); border-radius: 4px;">
                            <div style="color: var(--text-inverse); font-weight: bold; font-size: 12px;">
                                {% if note.is_pinned %}<i class="fas fa-thumbtack"></i> {% endif %}
                                {{ note.title }}
                            </div>
                            <div style="color: var(--text-inverse); font-size: 11px;">{{ note.content[:100] }}{% if note.content|length > 100 %}...{% endif %}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: var(--text-inverse); text-align: center; padding: 20px; font-weight: bold;">No recent notes</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.dataSourcesData = {{ data_sources | tojson }};
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeDataSources();
    checkGenerateButton();
});

function initializeDataSources() {
    const dataSourceSelect = document.getElementById('data-source');
    const xAxisSelect = document.getElementById('x-axis');
    const yAxisSelect = document.getElementById('y-axis');
    const zAxisSelect = document.getElementById('z-axis');
    
    dataSourceSelect.addEventListener('change', function() {
        const selectedSource = this.value;
        
        // Clear and populate axis selects
        xAxisSelect.innerHTML = '<option value="">Select X-Axis...</option>';
        yAxisSelect.innerHTML = '<option value="">Select Y-Axis...</option>';
        zAxisSelect.innerHTML = '<option value="">Select Z-Axis...</option>';
        
        if (selectedSource && window.dataSourcesData[selectedSource]) {
            const fields = window.dataSourcesData[selectedSource].fields;
            
            for (const [key, label] of Object.entries(fields)) {
                xAxisSelect.innerHTML += `<option value="${key}">${label}</option>`;
                yAxisSelect.innerHTML += `<option value="${key}">${label}</option>`;
                zAxisSelect.innerHTML += `<option value="${key}">${label}</option>`;
            }
            
            xAxisSelect.disabled = false;
            yAxisSelect.disabled = false;
            zAxisSelect.disabled = false;
        } else {
            xAxisSelect.disabled = true;
            yAxisSelect.disabled = true;
            zAxisSelect.disabled = true;
        }
        
        checkGenerateButton();
    });
    
    // Add change listeners to other selects
    xAxisSelect.addEventListener('change', checkGenerateButton);
    yAxisSelect.addEventListener('change', checkGenerateButton);
    document.getElementById('graph-type').addEventListener('change', checkGenerateButton);
}

function checkGenerateButton() {
    const dataSource = document.getElementById('data-source').value;
    const xAxis = document.getElementById('x-axis').value;
    const yAxis = document.getElementById('y-axis').value;
    
    const generateBtn = document.getElementById('generate-btn');
    const saveBtn = document.getElementById('save-preset-btn');
    const exportBtn = document.getElementById('export-btn');
    
    const isValid = dataSource && xAxis && yAxis;
    
    generateBtn.disabled = !isValid;
    saveBtn.disabled = !isValid;
    exportBtn.disabled = !isValid;
}

function generateGraph() {
    alert('Graph generation functionality - would integrate with backend analytics API');
}

function fullViewGraph(graphId) {
    alert('Full view for graph ' + graphId + ' - would open in modal/popup');
}

function removeGraph(graphId) {
    const graphElement = document.getElementById('graph-' + graphId);
    const graphContent = graphElement.querySelector('.graph-content');
    const graphTitle = graphElement.querySelector('.graph-title');
    
    // Reset to placeholder
    graphTitle.textContent = graphId === 1 ? 'Primary Analysis - Figure Display' : 'Secondary Analysis - Figure Display';
    graphContent.innerHTML = `
        <div class="graph-placeholder">
            <i class="fas fa-chart-line"></i>
            <p class="image-bg-text">${graphId === 1 ? 'Select data source and fields to generate a graph' : 'Additional analysis slot available'}</p>
        </div>
    `;
}

function addGraph() {
    alert('Add new graph functionality');
}

function clearGraphs() {
    removeGraph(1);
    removeGraph(2);
}

function saveAsPreset() {
    const name = prompt('Enter preset name:');
    if (name) {
        alert('Preset "' + name + '" saved successfully!');
    }
}

function exportToExcel() {
    alert('Export to Excel functionality');
}

function downloadTemplate(dataSource) {
    alert('Download template for ' + dataSource);
}

function addStatParameter() {
    const tbody = document.getElementById('stats-parameters');
    const newParam = prompt('Parameter name:');
    if (newParam) {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${newParam}</td>
            <td>--</td>
            <td><button class="graph-btn" onclick="removeStatParameter(this)"><i class="fas fa-minus"></i></button></td>
        `;
    }
}

function removeStatParameter(btn) {
    btn.closest('tr').remove();
}

function showAddReminderModal() {
    const title = prompt('Reminder Title:');
    if (title) {
        alert('Reminder "' + title + '" added successfully!');
    }
}

function showAddNoteModal() {
    const title = prompt('Note Title:');
    if (title) {
        alert('Note "' + title + '" added successfully!');
    }
}
</script>
{% endblock %}